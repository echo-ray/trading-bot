from unittest import TestCase, main
from feeds.okex import OkexFeed


full_depth = {'action': 'partial',
 'data': [{'asks': [['133.2199', '3.929856', 1],
                    ['133.22', '1', 1],
                    ['133.2259', '3.919', 1],
                    ['133.2264', '1.6725', 1],
                    ['133.2479', '1.55', 1],
                    ['133.2507', '0.405898', 1],
                    ['133.2508', '29.819641', 2],
                    ['133.2617', '3', 1],
                    ['133.2706', '10.337417', 1],
                    ['133.2727', '0.62', 1],
                    ['133.2773', '1.422516', 1],
                    ['133.2933', '56.367', 1],
                    ['133.2965', '0.65', 1],
                    ['133.3064', '0.748', 1],
                    ['133.3132', '41.302283', 3],
                    ['133.3164', '9.672384', 1],
                    ['133.3221', '0.749', 1],
                    ['133.3232', '15.017833', 1],
                    ['133.3313', '0.2', 1],
                    ['133.3339', '14.999943', 1],
                    ['133.3351', '1.487', 1],
                    ['133.3591', '1.493', 1],
                    ['133.3604', '0.037332', 1],
                    ['133.3618', '0.742', 1],
                    ['133.3622', '0.2993', 1],
                    ['133.3862', '7.507679', 1],
                    ['133.3999', '26.274161', 3],
                    ['133.4099', '30.028902', 1],
                    ['133.4116', '2.4', 1],
                    ['133.4188', '15.015358', 1],
                    ['133.4198', '30.03905', 1],
                    ['133.4425', '30.035126', 1],
                    ['133.4484', '0.005', 1],
                    ['133.47', '3.12', 1],
                    ['133.4823', '0.039945', 1],
                    ['133.4864', '30.03905', 1],
                    ['133.4899', '30.028902', 1],
                    ['133.4987', '0.13', 1],
                    ['133.5299', '30.028902', 1],
                    ['133.5409', '3.769', 1],
                    ['133.5457', '1.5', 1],
                    ['133.5483', '7.3', 1],
                    ['133.5486', '3.769', 1],
                    ['133.5492', '30.035126', 1],
                    ['133.5508', '1.669', 1],
                    ['133.5565', '30.028902', 1],
                    ['133.5858', '6', 1],
                    ['133.6158', '30.035126', 1],
                    ['133.6626', '2', 1],
                    ['133.6959', '0.5', 1],
                    ['133.696', '17.612832', 1],
                    ['133.73', '13.842847', 1],
                    ['133.7416', '15.068329', 1],
                    ['133.7692', '15.015358', 1],
                    ['133.7713', '52.875', 1],
                    ['133.7836', '0.22424', 1],
                    ['133.79', '15', 3],
                    ['133.7984', '15.06522', 1],
                    ['133.8', '15', 3],
                    ['133.8025', '1.501', 1],
                    ['133.8392', '15.072251', 1],
                    ['133.9061', '0.01', 1],
                    ['133.9079', '15.066217', 1],
                    ['133.9263', '271.55366', 1],
                    ['133.9587', '0.3', 1],
                    ['134.0192', '0.00976', 1],
                    ['134.0291', '0.299329', 1],
                    ['134.06', '4.29', 1],
                    ['134.0803', '0.0098', 1],
                    ['134.0856', '0.999', 1],
                    ['134.0878', '0.999', 1],
                    ['134.1359', '29', 1],
                    ['134.1426', '1.100818', 1],
                    ['134.1454', '0.745459', 1],
                    ['134.1552', '528.75', 1],
                    ['134.2139', '0.0092', 1],
                    ['134.254', '1.876772', 1],
                    ['134.3', '89.980405', 2],
                    ['134.3822', '160.169817', 1],
                    ['134.4855', '2.252873', 1],
                    ['134.4856', '0.999', 1],
                    ['134.4899', '0.999', 1],
                    ['134.5', '2', 1],
                    ['134.53', '9.474461', 1],
                    ['134.6791', '0.9985', 1],
                    ['134.7', '4.39', 2],
                    ['134.7905', '0.999', 1],
                    ['134.815', '0.999', 1],
                    ['134.8283', '0.999', 1],
                    ['134.8531', '0.999', 1],
                    ['134.8797', '4.782228', 1],
                    ['134.8798', '0.003', 1],
                    ['134.8888', '1.998', 1],
                    ['134.89', '2.189321', 1],
                    ['134.8919', '10', 1],
                    ['134.9361', '0.4895', 1],
                    ['134.9381', '1.4985', 2],
                    ['134.9629', '1.4985', 2],
                    ['134.9705', '1.4985', 2],
                    ['134.9777', '1.4985', 2],
                    ['134.9971', '1.4985', 3],
                    ['134.9976', '1.49825', 2],
                    ['135', '186.136438', 3],
                    ['135.0136', '1.4985', 2],
                    ['135.0185', '1.4985', 2],
                    ['135.0297', '1.4985', 2],
                    ['135.058', '1.49775', 2],
                    ['135.1054', '1.998', 3],
                    ['135.2025', '1.49808', 2],
                    ['135.2036', '2.0979', 4],
                    ['135.2169', '1.998', 3],
                    ['135.24', '0.05', 1],
                    ['135.2593', '2.2977', 5],
                    ['135.4', '271.635921', 2],
                    ['135.4502', '49.143149', 1],
                    ['135.5', '29.678331', 2],
                    ['135.5388', '0.0011', 1],
                    ['135.5434', '1.187999', 1],
                    ['135.6', '0.016503', 1],
                    ['135.7', '50', 1],
                    ['135.71', '0.05', 1],
                    ['135.7721', '5.816606', 1],
                    ['135.8041', '3.44655', 7],
                    ['135.875', '7.145', 1],
                    ['135.8881', '3.44655', 7],
                    ['135.8888', '2', 1],
                    ['135.8904', '3.44655', 7],
                    ['136', '329.023747', 8],
                    ['136.0461', '0.999', 1],
                    ['136.0738', '3.1968', 5],
                    ['136.0743', '0.00904', 1],
                    ['136.096', '5.633633', 10],
                    ['136.1358', '11.2873', 20],
                    ['136.2178', '0.524', 1],
                    ['136.2341', '4.14585', 9],
                    ['136.2387', '3.64635', 8],
                    ['136.2643', '162.684', 1],
                    ['136.2729', '4.14585', 9],
                    ['136.3', '0.002', 1],
                    ['136.304', '4.14585', 9],
                    ['136.3063', '4.64535', 11],
                    ['136.321', '7.04295', 13],
                    ['136.3563', '4.64535', 10],
                    ['136.3618', '5.64435', 11],
                    ['136.3653', '4.14585', 9],
                    ['136.4', '100', 1],
                    ['136.403', '11.2887', 23],
                    ['136.4218', '4.64535', 10],
                    ['136.4256', '5.64435', 12],
                    ['136.45', '0.168888', 1],
                    ['136.4526', '7.04295', 13],
                    ['136.4683', '13.6863', 26],
                    ['136.4686', '7.04295', 13],
                    ['136.4855', '5.64435', 11],
                    ['136.491', '7.04295', 13],
                    ['136.4999', '25', 1],
                    ['136.5', '44.342977', 2],
                    ['136.5165', '7.04285', 13],
                    ['136.5277', '7.04295', 14],
                    ['136.5571', '13.884475', 25],
                    ['136.6783', '0.74', 1],
                    ['136.696', '0.0097', 1],
                    ['136.8', '5', 1],
                    ['136.8676', '0.03938', 1],
                    ['136.9', '42.078085', 1],
                    ['136.9153', '0.00984', 1],
                    ['136.9481', '7.04295', 13],
                    ['136.9547', '0.624731', 1],
                    ['136.9779', '10', 1],
                    ['136.9855', '7.04295', 13],
                    ['136.9969', '7.04295', 13],
                    ['137', '137.399674', 4],
                    ['137.003', '7.04295', 13],
                    ['137.0246', '7.04295', 14],
                    ['137.0511', '7.04295', 13],
                    ['137.0693', '4.738447', 1],
                    ['137.1693', '5', 1],
                    ['137.2041', '1.919705', 1],
                    ['137.2693', '5', 1],
                    ['137.3276', '0.442715', 1],
                    ['137.33', '13.988763', 1],
                    ['137.3598', '0.00953', 1],
                    ['137.3693', '5', 1],
                    ['137.4693', '5', 1],
                    ['137.4999', '1', 1],
                    ['137.55', '2.11433', 1],
                    ['137.5693', '5', 1],
                    ['137.6', '5', 1],
                    ['137.6166', '0.3996', 1],
                    ['137.6693', '5', 1],
                    ['137.68', '2.997', 1],
                    ['137.7064', '9.741015', 1],
                    ['137.7387', '0.00969', 1],
                    ['137.7693', '5', 1],
                    ['137.8693', '5', 1],
                    ['137.8888', '1.603134', 1],
                    ['137.8939', '10', 1],
                    ['137.9', '30.221691', 2],
                    ['137.9039', '15', 1],
                    ['137.934', '0.00938', 1]],
           'bids': [['133.177', '4.44', 1],
                    ['133.1742', '0.860965', 1],
                    ['133.1741', '0.661912', 1],
                    ['133.1681', '0.018724', 1],
                    ['133.1633', '0.225018', 1],
                    ['133.1625', '2.846163', 1],
                    ['133.1553', '0.203989', 1],
                    ['133.152', '1', 1],
                    ['133.15', '0.360029', 1],
                    ['133.1472', '7.510479', 1],
                    ['133.146', '20', 1],
                    ['133.142', '0.326383', 1],
                    ['133.1383', '0.228493', 1],
                    ['133.1377', '0.38', 1],
                    ['133.1367', '0.576047', 1],
                    ['133.1287', '0.522213', 1],
                    ['133.125', '0.365589', 1],
                    ['133.1234', '0.921675', 1],
                    ['133.122', '0.268536', 1],
                    ['133.1154', '0.835543', 1],
                    ['133.1142', '56.194', 1],
                    ['133.113', '0.35', 1],
                    ['133.1117', '0.584942', 1],
                    ['133.11', '1.474681', 1],
                    ['133.1086', '0.062252', 1],
                    ['133.1021', '1.336868', 1],
                    ['133.099', '0.377994', 1],
                    ['133.0988', '10.933698', 1],
                    ['133.0984', '0.935908', 1],
                    ['133.0962', '0.727999', 1],
                    ['133.0904', '1.799', 1],
                    ['133.0867', '11.26126', 2],
                    ['133.0851', '1.497453', 1],
                    ['133.0834', '7.508471', 1],
                    ['133.0758', '0.005', 1],
                    ['133.0735', '15.017574', 1],
                    ['133.0701', '1.8', 1],
                    ['133.0688', '1.8', 1],
                    ['133.0676', '30.037336', 1],
                    ['133.0668', '0.15', 1],
                    ['133.0648', '0.15', 1],
                    ['133.0601', '3.753471', 1],
                    ['133.0597', '0.9', 1],
                    ['133.0595', '1.499', 1],
                    ['133.0581', '0.00989', 1],
                    ['133.0526', '1.05', 1],
                    ['133.0512', '1.05', 1],
                    ['133.0401', '7.507225', 1],
                    ['133.0368', '15.015015', 1],
                    ['133.0333', '0.01', 1],
                    ['133.0268', '30.026648', 1],
                    ['133.0244', '0.2', 1],
                    ['133.0214', '1.100818', 1],
                    ['133.0141', '0.724', 1],
                    ['133.0105', '3.00641', 1],
                    ['133.0001', '15.014451', 1],
                    ['133', '1', 1],
                    ['132.9786', '2.201636', 1],
                    ['132.9702', '30.028902', 1],
                    ['132.9641', '0.2993', 1],
                    ['132.9613', '2.105', 1],
                    ['132.961', '30.037336', 1],
                    ['132.926', '0.22569', 1],
                    ['132.9237', '0.5', 1],
                    ['132.9203', '30.026648', 1],
                    ['132.9096', '0.00976', 1],
                    ['132.8945', '30.037336', 1],
                    ['132.8909', '1.501', 1],
                    ['132.8903', '30.028902', 1],
                    ['132.8889', '6', 1],
                    ['132.8701', '0.004', 1],
                    ['132.86', '2.62', 1],
                    ['132.8537', '30.026648', 1],
                    ['132.8504', '30.028902', 1],
                    ['132.8503', '15.072251', 1],
                    ['132.8453', '1.5049', 1],
                    ['132.8452', '17.630985', 1],
                    ['132.8412', '142.999', 1],
                    ['132.84', '1', 1],
                    ['132.8392', '6.604978', 1],
                    ['132.8238', '30.028902', 1],
                    ['132.8181', '7.3', 1],
                    ['132.804', '1.05418', 1],
                    ['132.8015', '7', 1],
                    ['132.8', '3.5507', 2],
                    ['132.7738', '1.644315', 1],
                    ['132.7547', '15.014654', 1],
                    ['132.7529', '15.068293', 1],
                    ['132.7468', '2', 1],
                    ['132.72', '15', 3],
                    ['132.7162', '1.501', 1],
                    ['132.71', '20', 4],
                    ['132.7054', '52.875', 1],
                    ['132.6749', '15.072272', 1],
                    ['132.6608', '0.00987', 1],
                    ['132.5785', '15.068293', 1],
                    ['132.575', '0.0021', 1],
                    ['132.5249', '1.502', 1],
                    ['132.5211', '0.754596', 1],
                    ['132.5174', '0.01', 1],
                    ['132.5', '1', 1],
                    ['132.44', '5.39', 1],
                    ['132.4205', '2.92483', 1],
                    ['132.3462', '528.75', 1],
                    ['132.2992', '0.299329', 1],
                    ['132.2293', '1.876172', 1],
                    ['132.101', '0.514757', 1],
                    ['132.1', '1.47411', 1],
                    ['132.045', '0.07', 1],
                    ['132.0002', '2.272723', 1],
                    ['132.0001', '0.42', 1],
                    ['132', '17.367241', 8],
                    ['131.9902', '0.009019', 1],
                    ['131.8273', '15.453079', 1],
                    ['131.827', '25', 1],
                    ['131.82', '66.56835', 1],
                    ['131.813', '0.00904', 1],
                    ['131.6597', '0.2', 1],
                    ['131.5', '3.91635', 2],
                    ['131.36', '0.280561', 1],
                    ['131.2611', '0.039241', 1],
                    ['131.2523', '1.131408', 1],
                    ['131.2347', '0.009019', 1],
                    ['131.2', '0.542606', 1],
                    ['131.1', '5.449495', 1],
                    ['131.0774', '0.00903', 1],
                    ['131', '178.827286', 8],
                    ['130.9243', '0.00984', 1],
                    ['130.8503', '264.375', 1],
                    ['130.6869', '22.757391', 1],
                    ['130.6337', '0.00932', 1],
                    ['130.5', '121.732528', 4],
                    ['130.3466', '0.090045', 1],
                    ['130.25', '0.135646', 1],
                    ['130.2481', '94.352596', 1],
                    ['130.2131', '5.115264', 1],
                    ['130.1955', '6.50611', 1],
                    ['130.1864', '0.5', 1],
                    ['130.1099', '10', 1],
                    ['130.1', '7.503511', 2],
                    ['130.01', '0.65', 2],
                    ['130.0099', '10', 1],
                    ['130.0001', '70.307109', 7],
                    ['130', '79.016547', 17],
                    ['129.9371', '0.235902', 1],
                    ['129.79', '50', 1],
                    ['129.69', '100', 1],
                    ['129.68', '0.791981', 1],
                    ['129.66', '17.84261', 1],
                    ['129.63', '0.03', 1],
                    ['129.6105', '2.0378', 1],
                    ['129.5', '5.522773', 2],
                    ['129.4641', '105.75', 1],
                    ['129.43', '6.875836', 1],
                    ['129.35', '27.406681', 1],
                    ['129.3', '1.829234', 1],
                    ['129.25', '5.440039', 1],
                    ['129.22', '6.59', 1],
                    ['129.16', '400', 1],
                    ['129.1', '1.096734', 3],
                    ['129', '31.783076', 11],
                    ['128.88', '0.451', 1],
                    ['128.86', '15.932754', 1],
                    ['128.838', '40', 1],
                    ['128.8267', '0.141', 1],
                    ['128.6883', '52.875', 1],
                    ['128.63', '0.03', 1],
                    ['128.588', '2.530017', 1],
                    ['128.561', '0.15', 1],
                    ['128.5123', '1.051325', 1],
                    ['128.501', '1', 1],
                    ['128.5', '42.658085', 2],
                    ['128.4964', '5', 1],
                    ['128.4', '46.289417', 1],
                    ['128.3866', '0.2858', 1],
                    ['128.34', '0.1', 1],
                    ['128.25', '400', 1],
                    ['128.21', '4', 1],
                    ['128.125', '0.1', 1],
                    ['128.12', '1.5', 1],
                    ['128.1099', '15', 1],
                    ['128.1', '40', 2],
                    ['128.0188', '58.59618', 1],
                    ['128.016', '12.028348', 1],
                    ['128.01', '1.850329', 1],
                    ['128', '1466.347738', 26],
                    ['127.87', '9.158817', 1],
                    ['127.863', '0.01', 1],
                    ['127.7555', '0.5871', 1],
                    ['127.63', '0.03', 1],
                    ['127.6044', '0.5878', 1],
                    ['127.52', '0.013101', 1],
                    ['127.5103', '2', 1],
                    ['127.5', '20.611278', 4],
                    ['127.3927', '0.3679', 1],
                    ['127.36', '0.5889', 1],
                    ['127.312', '0.5', 1],
                    ['127.3', '6.728186', 3],
                    ['127.2', '23.196989', 2],
                    ['127.18', '0.501', 1]],
           'checksum': 1478308601,
           'instrument_id': 'ETH-USDT',
           'timestamp': '2019-03-02T13:06:40.987Z'}],
 'table': 'spot/depth'}

depth_update = {'action': 'update',
 'data': [{'asks': [['133.2425', '3', 1],
                    ['133.2773', '0', 0],
                    ['133.2845', '1.815023', 1],
                    ['133.2965', '0', 0],
                    ['133.2985', '0.65', 1],
                    ['133.3313', '0', 0],
                    ['133.3351', '0', 0],
                    ['133.3604', '0', 0],
                    ['133.3618', '0', 0],
                    ['133.3862', '0', 0],
                    ['133.3998', '8.59895', 1],
                    ['133.413', '7.507594', 1],
                    ['133.4188', '0', 0],
                    ['133.4397', '15.015189', 1],
                    ['133.4425', '0', 0],
                    ['133.5492', '0', 0],
                    ['133.5591', '1.669', 1],
                    ['133.6158', '0', 0],
                    ['133.6498', '0.0751', 1],
                    ['134.1426', '0', 0],
                    ['134.1454', '0', 0],
                    ['137.9693', '5', 1],
                    ['137.9876', '15.21', 1],
                    ['137.9998', '54.033725', 1],
                    ['138', '639.023284', 13],
                    ['138.0126', '7.429357', 1]],
           'bids': [['133.1771', '0.516742', 1],
                    ['133.1753', '1.398473', 1],
                    ['133.1742', '0', 0],
                    ['133.1741', '0', 0],
                    ['133.1717', '2.497471', 1],
                    ['133.1625', '0', 0],
                    ['133.1473', '0.140554', 1],
                    ['133.1383', '0', 0],
                    ['133.1377', '0', 0],
                    ['133.134', '0.224886', 1],
                    ['133.125', '0', 0],
                    ['133.1229', '0.372028', 1],
                    ['133.1207', '0.359818', 1],
                    ['133.1117', '0', 0],
                    ['133.1086', '0', 0],
                    ['133.099', '0', 0],
                    ['133.0984', '0', 0],
                    ['133.0973', '0.069252', 1],
                    ['133.0851', '0', 0],
                    ['133.0726', '8.83696', 1],
                    ['133.0701', '0', 0],
                    ['133.0601', '11.260696', 2],
                    ['133.0595', '0', 0],
                    ['133.0401', '15.014451', 1],
                    ['133.0341', '0.016', 1],
                    ['133.0105', '0', 0],
                    ['133.0001', '0', 0],
                    ['132.9907', '0.2993', 1],
                    ['132.9641', '0', 0],
                    ['132.9369', '0.0751', 1],
                    ['132.8392', '0', 0],
                    ['132.7738', '0', 0],
                    ['132.5211', '0', 0],
                    ['132.3257', '0.299329', 1],
                    ['132.2992', '0', 0],
                    ['127.1202', '7.97971', 1],
                    ['127.1155', '0.3147', 1],
                    ['127.06', '18.178275', 1],
                    ['127.0364', '2205.589513', 1],
                    ['127.02', '1.723518', 2],
                    ['127.01', '1.864898', 1],
                    ['127.0063', '2', 1]],
           'checksum': 911928389,
           'instrument_id': 'ETH-USDT',
           'timestamp': '2019-03-02T13:06:41.609Z'}],
 'table': 'spot/depth'}


class OkexFeedTest(TestCase):
    def test_bids_asks_from_msg(self):
        feed = OkexFeed()
        self.assertEqual(
            feed.asks_from_msg(
                full_depth
            ),
            full_depth["data"][0]["asks"]
        )
        self.assertEqual(
            feed.asks_from_msg(
                depth_update
            ),
            depth_update["data"][0]["asks"]
        )

        self.assertEqual(
            feed.bids_from_msg(
                full_depth
            ),
            full_depth["data"][0]["bids"]
        )
        self.assertEqual(
            feed.bids_from_msg(
                depth_update
            ),
            depth_update["data"][0]["bids"]
        )

    def test_ask_bid_deleted(self):
        feed = OkexFeed()
        self.assertFalse(
            feed.ask_bid_deleted(['133.3998', '8.59895', 1],)
        )
        self.assertTrue(
            feed.ask_bid_deleted(['133.3862', '0', 0],)
        )


if __name__ == '__main__':
    main()
